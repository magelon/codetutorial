{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{dB9c:function(module,__webpack_exports__,__webpack_require__){\"use strict\";__webpack_require__.r(__webpack_exports__);var index_esm_a,index_cjs=__webpack_require__(\"wj3C\"),index_cjs_default=__webpack_require__.n(index_cjs),tslib_es6=__webpack_require__(\"mrSG\"),dist_index_cjs=__webpack_require__(\"zVF4\"),ERROR_MAP=((index_esm_a={})[\"only-available-in-window\"]=\"This method is available in a Window context.\",index_esm_a[\"only-available-in-sw\"]=\"This method is available in a service worker context.\",index_esm_a[\"should-be-overriden\"]=\"This method should be overriden by extended classes.\",index_esm_a[\"bad-sender-id\"]=\"Please ensure that 'messagingSenderId' is set correctly in the options passed into firebase.initializeApp().\",index_esm_a[\"permission-default\"]=\"The required permissions were not granted and dismissed instead.\",index_esm_a[\"permission-blocked\"]=\"The required permissions were not granted and blocked instead.\",index_esm_a[\"unsupported-browser\"]=\"This browser doesn't support the API's required to use the firebase SDK.\",index_esm_a[\"notifications-blocked\"]=\"Notifications have been blocked.\",index_esm_a[\"failed-serviceworker-registration\"]=\"We are unable to register the default service worker. {$browserErrorMessage}\",index_esm_a[\"sw-registration-expected\"]=\"A service worker registration was the expected input.\",index_esm_a[\"get-subscription-failed\"]=\"There was an error when trying to get any existing Push Subscriptions.\",index_esm_a[\"invalid-saved-token\"]=\"Unable to access details of the saved token.\",index_esm_a[\"sw-reg-redundant\"]=\"The service worker being used for push was made redundant.\",index_esm_a[\"token-subscribe-failed\"]=\"A problem occured while subscribing the user to FCM: {$errorInfo}\",index_esm_a[\"token-subscribe-no-token\"]=\"FCM returned no token when subscribing the user to push.\",index_esm_a[\"token-subscribe-no-push-set\"]=\"FCM returned an invalid response when getting an FCM token.\",index_esm_a[\"token-unsubscribe-failed\"]=\"A problem occured while unsubscribing the user from FCM: {$errorInfo}\",index_esm_a[\"token-update-failed\"]=\"A problem occured while updating the user from FCM: {$errorInfo}\",index_esm_a[\"token-update-no-token\"]=\"FCM returned no token when updating the user to push.\",index_esm_a[\"use-sw-before-get-token\"]=\"The useServiceWorker() method may only be called once and must be called before calling getToken() to ensure your service worker is used.\",index_esm_a[\"invalid-delete-token\"]=\"You must pass a valid token into deleteToken(), i.e. the token from getToken().\",index_esm_a[\"delete-token-not-found\"]=\"The deletion attempt for token could not be performed as the token was not found.\",index_esm_a[\"delete-scope-not-found\"]=\"The deletion attempt for service worker scope could not be performed as the scope was not found.\",index_esm_a[\"bg-handler-function-expected\"]=\"The input to setBackgroundMessageHandler() must be a function.\",index_esm_a[\"no-window-client-to-msg\"]=\"An attempt was made to message a non-existant window client.\",index_esm_a[\"unable-to-resubscribe\"]=\"There was an error while re-subscribing the FCM token for push messaging. Will have to resubscribe the user on next visit. {$errorInfo}\",index_esm_a[\"no-fcm-token-for-resubscribe\"]=\"Could not find an FCM token and as a result, unable to resubscribe. Will have to resubscribe the user on next visit.\",index_esm_a[\"failed-to-delete-token\"]=\"Unable to delete the currently saved token.\",index_esm_a[\"no-sw-in-reg\"]=\"Even though the service worker registration was successful, there was a problem accessing the service worker itself.\",index_esm_a[\"incorrect-gcm-sender-id\"]=\"Please change your web app manifest's 'gcm_sender_id' value to '103953800507' to use Firebase messaging.\",index_esm_a[\"bad-scope\"]=\"The service worker scope must be a string with at least one character.\",index_esm_a[\"bad-vapid-key\"]=\"The public VAPID key is not a Uint8Array with 65 bytes.\",index_esm_a[\"bad-subscription\"]=\"The subscription must be a valid PushSubscription.\",index_esm_a[\"bad-token\"]=\"The FCM Token used for storage / lookup was not a valid token string.\",index_esm_a[\"bad-push-set\"]=\"The FCM push set used for storage / lookup was not not a valid push set string.\",index_esm_a[\"failed-delete-vapid-key\"]=\"The VAPID key could not be deleted.\",index_esm_a[\"invalid-public-vapid-key\"]=\"The public VAPID key must be a string.\",index_esm_a[\"use-public-key-before-get-token\"]=\"The usePublicVapidKey() method may only be called once and must be called before calling getToken() to ensure your VAPID key is used.\",index_esm_a[\"public-vapid-key-decryption-failed\"]=\"The public VAPID key did not equal 65 bytes when decrypted.\",index_esm_a),errorFactory=new dist_index_cjs.ErrorFactory(\"messaging\",\"Messaging\",ERROR_MAP),DEFAULT_PUBLIC_VAPID_KEY=new Uint8Array([4,51,148,247,223,161,235,177,220,3,162,94,21,113,219,72,211,46,237,237,178,52,219,183,71,58,12,143,196,204,225,111,60,140,132,223,171,182,102,62,242,12,212,139,254,227,249,118,47,20,28,99,8,106,111,45,177,26,149,176,206,55,192,156,110]),ENDPOINT=\"https://fcm.googleapis.com\",MessageParameter=function(MessageParameter){return MessageParameter.TYPE_OF_MSG=\"firebase-messaging-msg-type\",MessageParameter.DATA=\"firebase-messaging-msg-data\",MessageParameter}({}),MessageType=function(MessageType){return MessageType.PUSH_MSG_RECEIVED=\"push-msg-received\",MessageType.NOTIFICATION_CLICKED=\"notification-clicked\",MessageType}({});function isArrayBufferEqual(a,b){if(null==a||null==b)return!1;if(a===b)return!0;if(a.byteLength!==b.byteLength)return!1;for(var viewA=new DataView(a),viewB=new DataView(b),i=0;i<a.byteLength;i++)if(viewA.getUint8(i)!==viewB.getUint8(i))return!1;return!0}function arrayBufferToBase64(arrayBuffer){return function(arrayBuffer){var uint8Version=new Uint8Array(arrayBuffer);return btoa(String.fromCharCode.apply(String,Object(tslib_es6.__spread)(uint8Version)))}(arrayBuffer).replace(/=/g,\"\").replace(/\\+/g,\"-\").replace(/\\//g,\"_\")}var index_esm_IidModel=function(){function IidModel(){}return IidModel.prototype.getToken=function(senderId,subscription,publicVapidKey){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var p256dh,auth,fcmSubscribeBody,applicationPubKey,headers,subscribeOptions,responseData,err_1;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:p256dh=arrayBufferToBase64(subscription.getKey(\"p256dh\")),auth=arrayBufferToBase64(subscription.getKey(\"auth\")),fcmSubscribeBody=\"authorized_entity=\"+senderId+\"&endpoint=\"+subscription.endpoint+\"&encryption_key=\"+p256dh+\"&encryption_auth=\"+auth,isArrayBufferEqual(publicVapidKey.buffer,DEFAULT_PUBLIC_VAPID_KEY.buffer)||(applicationPubKey=arrayBufferToBase64(publicVapidKey),fcmSubscribeBody+=\"&application_pub_key=\"+applicationPubKey),(headers=new Headers).append(\"Content-Type\",\"application/x-www-form-urlencoded\"),subscribeOptions={method:\"POST\",headers:headers,body:fcmSubscribeBody},_a.label=1;case 1:return _a.trys.push([1,4,,5]),[4,fetch(ENDPOINT+\"/fcm/connect/subscribe\",subscribeOptions)];case 2:return[4,_a.sent().json()];case 3:return responseData=_a.sent(),[3,5];case 4:throw err_1=_a.sent(),errorFactory.create(\"token-subscribe-failed\",{errorInfo:err_1});case 5:if(responseData.error)throw errorFactory.create(\"token-subscribe-failed\",{errorInfo:responseData.error.message});if(!responseData.token)throw errorFactory.create(\"token-subscribe-no-token\");if(!responseData.pushSet)throw errorFactory.create(\"token-subscribe-no-push-set\");return[2,{token:responseData.token,pushSet:responseData.pushSet}]}}))}))},IidModel.prototype.updateToken=function(senderId,fcmToken,fcmPushSet,subscription,publicVapidKey){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var p256dh,auth,fcmUpdateBody,applicationPubKey,headers,updateOptions,responseData,err_2;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:p256dh=arrayBufferToBase64(subscription.getKey(\"p256dh\")),auth=arrayBufferToBase64(subscription.getKey(\"auth\")),fcmUpdateBody=\"push_set=\"+fcmPushSet+\"&token=\"+fcmToken+\"&authorized_entity=\"+senderId+\"&endpoint=\"+subscription.endpoint+\"&encryption_key=\"+p256dh+\"&encryption_auth=\"+auth,isArrayBufferEqual(publicVapidKey.buffer,DEFAULT_PUBLIC_VAPID_KEY.buffer)||(applicationPubKey=arrayBufferToBase64(publicVapidKey),fcmUpdateBody+=\"&application_pub_key=\"+applicationPubKey),(headers=new Headers).append(\"Content-Type\",\"application/x-www-form-urlencoded\"),updateOptions={method:\"POST\",headers:headers,body:fcmUpdateBody},_a.label=1;case 1:return _a.trys.push([1,4,,5]),[4,fetch(ENDPOINT+\"/fcm/connect/subscribe\",updateOptions)];case 2:return[4,_a.sent().json()];case 3:return responseData=_a.sent(),[3,5];case 4:throw err_2=_a.sent(),errorFactory.create(\"token-update-failed\",{errorInfo:err_2});case 5:if(responseData.error)throw errorFactory.create(\"token-update-failed\",{errorInfo:responseData.error.message});if(!responseData.token)throw errorFactory.create(\"token-update-no-token\");return[2,responseData.token]}}))}))},IidModel.prototype.deleteToken=function(senderId,fcmToken,fcmPushSet){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var fcmUnsubscribeBody,headers,unsubscribeOptions,responseData,err_3;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:fcmUnsubscribeBody=\"authorized_entity=\"+senderId+\"&token=\"+fcmToken+\"&pushSet=\"+fcmPushSet,(headers=new Headers).append(\"Content-Type\",\"application/x-www-form-urlencoded\"),unsubscribeOptions={method:\"POST\",headers:headers,body:fcmUnsubscribeBody},_a.label=1;case 1:return _a.trys.push([1,4,,5]),[4,fetch(ENDPOINT+\"/fcm/connect/unsubscribe\",unsubscribeOptions)];case 2:return[4,_a.sent().json()];case 3:if((responseData=_a.sent()).error)throw errorFactory.create(\"token-unsubscribe-failed\",{errorInfo:responseData.error.message});return[3,5];case 4:throw err_3=_a.sent(),errorFactory.create(\"token-unsubscribe-failed\",{errorInfo:err_3});case 5:return[2]}}))}))},IidModel}();function base64ToArrayBuffer(base64String){for(var base64=(base64String+\"=\".repeat((4-base64String.length%4)%4)).replace(/\\-/g,\"+\").replace(/_/g,\"/\"),rawData=atob(base64),outputArray=new Uint8Array(rawData.length),i=0;i<rawData.length;++i)outputArray[i]=rawData.charCodeAt(i);return outputArray}var index_esm_DbInterface=function(){function DbInterface(){this.dbPromise=null}return DbInterface.prototype.get=function(key){return this.createTransaction((function(objectStore){return objectStore.get(key)}))},DbInterface.prototype.getIndex=function(index,key){return this.createTransaction((function(objectStore){return objectStore.index(index).get(key)}))},DbInterface.prototype.put=function(value){return this.createTransaction((function(objectStore){return objectStore.put(value)}),\"readwrite\")},DbInterface.prototype.delete=function(key){return this.createTransaction((function(objectStore){return objectStore.delete(key)}),\"readwrite\")},DbInterface.prototype.closeDatabase=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return this.dbPromise?[4,this.dbPromise]:[3,2];case 1:_a.sent().close(),this.dbPromise=null,_a.label=2;case 2:return[2]}}))}))},DbInterface.prototype.createTransaction=function(runRequest,mode){return void 0===mode&&(mode=\"readonly\"),Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var db,transaction,request,result;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,this.getDb()];case 1:return db=_a.sent(),transaction=db.transaction(this.objectStoreName,mode),request=transaction.objectStore(this.objectStoreName),[4,promisify(runRequest(request))];case 2:return result=_a.sent(),[2,new Promise((function(resolve,reject){transaction.oncomplete=function(){resolve(result)},transaction.onerror=function(){reject(transaction.error)}}))]}}))}))},DbInterface.prototype.getDb=function(){var _this=this;return this.dbPromise||(this.dbPromise=new Promise((function(resolve,reject){var request=indexedDB.open(_this.dbName,_this.dbVersion);request.onsuccess=function(){resolve(request.result)},request.onerror=function(){_this.dbPromise=null,reject(request.error)},request.onupgradeneeded=function(event){return _this.onDbUpgrade(request,event)}}))),this.dbPromise},DbInterface}();function promisify(request){return new Promise((function(resolve,reject){request.onsuccess=function(){resolve(request.result)},request.onerror=function(){reject(request.error)}}))}var index_esm_TokenDetailsModel=function(_super){function TokenDetailsModel(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.dbName=\"fcm_token_details_db\",_this.dbVersion=3,_this.objectStoreName=\"fcm_token_object_Store\",_this}return Object(tslib_es6.__extends)(TokenDetailsModel,_super),TokenDetailsModel.prototype.onDbUpgrade=function(request,event){var db=request.result;switch(event.oldVersion){case 0:(objectStore=db.createObjectStore(this.objectStoreName,{keyPath:\"swScope\"})).createIndex(\"fcmSenderId\",\"fcmSenderId\",{unique:!1}),objectStore.createIndex(\"fcmToken\",\"fcmToken\",{unique:!0});case 1:!function(){var request=indexedDB.open(\"undefined\");request.onerror=function(_event){},request.onsuccess=function(_event){!function(db){if(db.objectStoreNames.contains(\"fcm_token_object_Store\")){var objectStore=db.transaction(\"fcm_token_object_Store\").objectStore(\"fcm_token_object_Store\"),iidModel=new index_esm_IidModel,openCursorRequest=objectStore.openCursor();openCursorRequest.onerror=function(event){console.warn(\"Unable to cleanup old IDB.\",event)},openCursorRequest.onsuccess=function(){var cursor=openCursorRequest.result;if(cursor){var tokenDetails=cursor.value;iidModel.deleteToken(tokenDetails.fcmSenderId,tokenDetails.fcmToken,tokenDetails.fcmPushSet),cursor.continue()}else db.close(),indexedDB.deleteDatabase(\"undefined\")}}}(request.result)}}();case 2:var objectStore,cursorRequest_1=(objectStore=request.transaction.objectStore(this.objectStoreName)).openCursor();cursorRequest_1.onsuccess=function(){var cursor=cursorRequest_1.result;if(cursor){var value=cursor.value,newValue=Object(tslib_es6.__assign)({},value);value.createTime||(newValue.createTime=Date.now()),\"string\"==typeof value.vapidKey&&(newValue.vapidKey=base64ToArrayBuffer(value.vapidKey)),\"string\"==typeof value.auth&&(newValue.auth=base64ToArrayBuffer(value.auth).buffer),\"string\"==typeof value.auth&&(newValue.p256dh=base64ToArrayBuffer(value.p256dh).buffer),cursor.update(newValue),cursor.continue()}}}},TokenDetailsModel.prototype.getTokenDetailsFromToken=function(fcmToken){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){if(!fcmToken)throw errorFactory.create(\"bad-token\");return validateInputs({fcmToken:fcmToken}),[2,this.getIndex(\"fcmToken\",fcmToken)]}))}))},TokenDetailsModel.prototype.getTokenDetailsFromSWScope=function(swScope){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){if(!swScope)throw errorFactory.create(\"bad-scope\");return validateInputs({swScope:swScope}),[2,this.get(swScope)]}))}))},TokenDetailsModel.prototype.saveTokenDetails=function(tokenDetails){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){if(!tokenDetails.swScope)throw errorFactory.create(\"bad-scope\");if(!tokenDetails.vapidKey)throw errorFactory.create(\"bad-vapid-key\");if(!tokenDetails.endpoint||!tokenDetails.auth||!tokenDetails.p256dh)throw errorFactory.create(\"bad-subscription\");if(!tokenDetails.fcmSenderId)throw errorFactory.create(\"bad-sender-id\");if(!tokenDetails.fcmToken)throw errorFactory.create(\"bad-token\");if(!tokenDetails.fcmPushSet)throw errorFactory.create(\"bad-push-set\");return validateInputs(tokenDetails),[2,this.put(tokenDetails)]}))}))},TokenDetailsModel.prototype.deleteToken=function(token){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var details;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return\"string\"!=typeof token||0===token.length?[2,Promise.reject(errorFactory.create(\"invalid-delete-token\"))]:[4,this.getTokenDetailsFromToken(token)];case 1:if(!(details=_a.sent()))throw errorFactory.create(\"delete-token-not-found\");return[4,this.delete(details.swScope)];case 2:return _a.sent(),[2,details]}}))}))},TokenDetailsModel}(index_esm_DbInterface);function validateInputs(input){if(input.fcmToken&&(\"string\"!=typeof input.fcmToken||0===input.fcmToken.length))throw errorFactory.create(\"bad-token\");if(input.swScope&&(\"string\"!=typeof input.swScope||0===input.swScope.length))throw errorFactory.create(\"bad-scope\");if(input.vapidKey&&(!(input.vapidKey instanceof Uint8Array)||65!==input.vapidKey.length))throw errorFactory.create(\"bad-vapid-key\");if(input.endpoint&&(\"string\"!=typeof input.endpoint||0===input.endpoint.length))throw errorFactory.create(\"bad-subscription\");if(input.auth&&!(input.auth instanceof ArrayBuffer))throw errorFactory.create(\"bad-subscription\");if(input.p256dh&&!(input.p256dh instanceof ArrayBuffer))throw errorFactory.create(\"bad-subscription\");if(input.fcmSenderId&&(\"string\"!=typeof input.fcmSenderId||0===input.fcmSenderId.length))throw errorFactory.create(\"bad-sender-id\");if(input.fcmPushSet&&(\"string\"!=typeof input.fcmPushSet||0===input.fcmPushSet.length))throw errorFactory.create(\"bad-push-set\")}var index_esm_VapidDetailsModel=function(_super){function VapidDetailsModel(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.dbName=\"fcm_vapid_details_db\",_this.dbVersion=1,_this.objectStoreName=\"fcm_vapid_object_Store\",_this}return Object(tslib_es6.__extends)(VapidDetailsModel,_super),VapidDetailsModel.prototype.onDbUpgrade=function(request){request.result.createObjectStore(this.objectStoreName,{keyPath:\"swScope\"})},VapidDetailsModel.prototype.getVapidFromSWScope=function(swScope){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var result;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:if(\"string\"!=typeof swScope||0===swScope.length)throw errorFactory.create(\"bad-scope\");return[4,this.get(swScope)];case 1:return[2,(result=_a.sent())?result.vapidKey:void 0]}}))}))},VapidDetailsModel.prototype.saveVapidDetails=function(swScope,vapidKey){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){if(\"string\"!=typeof swScope||0===swScope.length)throw errorFactory.create(\"bad-scope\");if(null===vapidKey||65!==vapidKey.length)throw errorFactory.create(\"bad-vapid-key\");return[2,this.put({swScope:swScope,vapidKey:vapidKey})]}))}))},VapidDetailsModel.prototype.deleteVapidDetails=function(swScope){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var vapidKey;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,this.getVapidFromSWScope(swScope)];case 1:if(!(vapidKey=_a.sent()))throw errorFactory.create(\"delete-scope-not-found\");return[4,this.delete(swScope)];case 2:return _a.sent(),[2,vapidKey]}}))}))},VapidDetailsModel}(index_esm_DbInterface),SENDER_ID_OPTION_NAME=\"messagingSenderId\",index_esm_BaseController=function(){function BaseController(app){var _this=this;if(!app.options[SENDER_ID_OPTION_NAME]||\"string\"!=typeof app.options[SENDER_ID_OPTION_NAME])throw errorFactory.create(\"bad-sender-id\");this.messagingSenderId=app.options[SENDER_ID_OPTION_NAME],this.tokenDetailsModel=new index_esm_TokenDetailsModel,this.vapidDetailsModel=new index_esm_VapidDetailsModel,this.iidModel=new index_esm_IidModel,this.app=app,this.INTERNAL={delete:function(){return _this.delete()}}}return BaseController.prototype.getToken=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var currentPermission,swReg,publicVapidKey,pushSubscription,tokenDetails;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:if(\"denied\"===(currentPermission=this.getNotificationPermission_()))throw errorFactory.create(\"notifications-blocked\");return\"granted\"!==currentPermission?[2,null]:[4,this.getSWRegistration_()];case 1:return swReg=_a.sent(),[4,this.getPublicVapidKey_()];case 2:return publicVapidKey=_a.sent(),[4,this.getPushSubscription(swReg,publicVapidKey)];case 3:return pushSubscription=_a.sent(),[4,this.tokenDetailsModel.getTokenDetailsFromSWScope(swReg.scope)];case 4:return(tokenDetails=_a.sent())?[2,this.manageExistingToken(swReg,pushSubscription,publicVapidKey,tokenDetails)]:[2,this.getNewToken(swReg,pushSubscription,publicVapidKey)]}}))}))},BaseController.prototype.manageExistingToken=function(swReg,pushSubscription,publicVapidKey,tokenDetails){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return function(pushSubscription,publicVapidKey,tokenDetails){if(!tokenDetails.vapidKey||!isArrayBufferEqual(publicVapidKey.buffer,tokenDetails.vapidKey.buffer))return!1;var isEndpointEqual=pushSubscription.endpoint===tokenDetails.endpoint,isAuthEqual=isArrayBufferEqual(pushSubscription.getKey(\"auth\"),tokenDetails.auth),isP256dhEqual=isArrayBufferEqual(pushSubscription.getKey(\"p256dh\"),tokenDetails.p256dh);return isEndpointEqual&&isAuthEqual&&isP256dhEqual}(pushSubscription,publicVapidKey,tokenDetails)?Date.now()<tokenDetails.createTime+6048e5?[2,tokenDetails.fcmToken]:[2,this.updateToken(swReg,pushSubscription,publicVapidKey,tokenDetails)]:[4,this.deleteTokenFromDB(tokenDetails.fcmToken)];case 1:return _a.sent(),[2,this.getNewToken(swReg,pushSubscription,publicVapidKey)]}}))}))},BaseController.prototype.updateToken=function(swReg,pushSubscription,publicVapidKey,tokenDetails){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var updatedToken,allDetails,e_1;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return _a.trys.push([0,4,,6]),[4,this.iidModel.updateToken(this.messagingSenderId,tokenDetails.fcmToken,tokenDetails.fcmPushSet,pushSubscription,publicVapidKey)];case 1:return updatedToken=_a.sent(),allDetails={swScope:swReg.scope,vapidKey:publicVapidKey,fcmSenderId:this.messagingSenderId,fcmToken:updatedToken,fcmPushSet:tokenDetails.fcmPushSet,createTime:Date.now(),endpoint:pushSubscription.endpoint,auth:pushSubscription.getKey(\"auth\"),p256dh:pushSubscription.getKey(\"p256dh\")},[4,this.tokenDetailsModel.saveTokenDetails(allDetails)];case 2:return _a.sent(),[4,this.vapidDetailsModel.saveVapidDetails(swReg.scope,publicVapidKey)];case 3:return _a.sent(),[2,updatedToken];case 4:return e_1=_a.sent(),[4,this.deleteToken(tokenDetails.fcmToken)];case 5:throw _a.sent(),e_1;case 6:return[2]}}))}))},BaseController.prototype.getNewToken=function(swReg,pushSubscription,publicVapidKey){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var tokenDetails,allDetails;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,this.iidModel.getToken(this.messagingSenderId,pushSubscription,publicVapidKey)];case 1:return tokenDetails=_a.sent(),allDetails={swScope:swReg.scope,vapidKey:publicVapidKey,fcmSenderId:this.messagingSenderId,fcmToken:tokenDetails.token,fcmPushSet:tokenDetails.pushSet,createTime:Date.now(),endpoint:pushSubscription.endpoint,auth:pushSubscription.getKey(\"auth\"),p256dh:pushSubscription.getKey(\"p256dh\")},[4,this.tokenDetailsModel.saveTokenDetails(allDetails)];case 2:return _a.sent(),[4,this.vapidDetailsModel.saveVapidDetails(swReg.scope,publicVapidKey)];case 3:return _a.sent(),[2,tokenDetails.token]}}))}))},BaseController.prototype.deleteToken=function(token){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var registration,pushSubscription;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,this.deleteTokenFromDB(token)];case 1:return _a.sent(),[4,this.getSWRegistration_()];case 2:return(registration=_a.sent())?[4,registration.pushManager.getSubscription()]:[3,4];case 3:if(pushSubscription=_a.sent())return[2,pushSubscription.unsubscribe()];_a.label=4;case 4:return[2,!0]}}))}))},BaseController.prototype.deleteTokenFromDB=function(token){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var details;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,this.tokenDetailsModel.deleteToken(token)];case 1:return details=_a.sent(),[4,this.iidModel.deleteToken(details.fcmSenderId,details.fcmToken,details.fcmPushSet)];case 2:return _a.sent(),[2]}}))}))},BaseController.prototype.getPushSubscription=function(swRegistration,publicVapidKey){return swRegistration.pushManager.getSubscription().then((function(subscription){return subscription||swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:publicVapidKey})}))},BaseController.prototype.requestPermission=function(){throw errorFactory.create(\"only-available-in-window\")},BaseController.prototype.useServiceWorker=function(_registration){throw errorFactory.create(\"only-available-in-window\")},BaseController.prototype.usePublicVapidKey=function(_b64PublicKey){throw errorFactory.create(\"only-available-in-window\")},BaseController.prototype.onMessage=function(_nextOrObserver,_error,_completed){throw errorFactory.create(\"only-available-in-window\")},BaseController.prototype.onTokenRefresh=function(_nextOrObserver,_error,_completed){throw errorFactory.create(\"only-available-in-window\")},BaseController.prototype.setBackgroundMessageHandler=function(_callback){throw errorFactory.create(\"only-available-in-sw\")},BaseController.prototype.delete=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,Promise.all([this.tokenDetailsModel.closeDatabase(),this.vapidDetailsModel.closeDatabase()])];case 1:return _a.sent(),[2]}}))}))},BaseController.prototype.getNotificationPermission_=function(){return Notification.permission},BaseController.prototype.getTokenDetailsModel=function(){return this.tokenDetailsModel},BaseController.prototype.getVapidDetailsModel=function(){return this.vapidDetailsModel},BaseController.prototype.getIidModel=function(){return this.iidModel},BaseController}(),index_esm_SwController=function(_super){function SwController(app){var _this=_super.call(this,app)||this;return _this.bgMessageHandler=null,self.addEventListener(\"push\",(function(e){_this.onPush(e)})),self.addEventListener(\"pushsubscriptionchange\",(function(e){_this.onSubChange(e)})),self.addEventListener(\"notificationclick\",(function(e){_this.onNotificationClick(e)})),_this}return Object(tslib_es6.__extends)(SwController,_super),SwController.prototype.onPush=function(event){event.waitUntil(this.onPush_(event))},SwController.prototype.onSubChange=function(event){event.waitUntil(this.onSubChange_(event))},SwController.prototype.onNotificationClick=function(event){event.waitUntil(this.onNotificationClick_(event))},SwController.prototype.onPush_=function(event){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var msgPayload,notificationDetails,notificationTitle,reg,actions,maxActions;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:if(!event.data)return[2];try{msgPayload=event.data.json()}catch(err){return[2]}return[4,this.hasVisibleClients_()];case 1:return _a.sent()?[2,this.sendMessageToWindowClients_(msgPayload)]:(notificationDetails=this.getNotificationData_(msgPayload))?(notificationTitle=notificationDetails.title||\"\",[4,this.getSWRegistration_()]):[3,3];case 2:return reg=_a.sent(),actions=notificationDetails.actions,maxActions=Notification.maxActions,actions&&maxActions&&actions.length>maxActions&&console.warn(\"This browser only supports \"+maxActions+\" actions.The remaining actions will not be displayed.\"),[2,reg.showNotification(notificationTitle,notificationDetails)];case 3:return this.bgMessageHandler?[4,this.bgMessageHandler(msgPayload)]:[3,5];case 4:return _a.sent(),[2];case 5:return[2]}}))}))},SwController.prototype.onSubChange_=function(_event){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var registration,err_1,err_2,tokenDetails;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return _a.trys.push([0,2,,3]),[4,this.getSWRegistration_()];case 1:return registration=_a.sent(),[3,3];case 2:throw err_1=_a.sent(),errorFactory.create(\"unable-to-resubscribe\",{errorInfo:err_1});case 3:return _a.trys.push([3,5,,8]),[4,registration.pushManager.getSubscription()];case 4:return _a.sent(),[3,8];case 5:return err_2=_a.sent(),[4,this.getTokenDetailsModel().getTokenDetailsFromSWScope(registration.scope)];case 6:if(!(tokenDetails=_a.sent()))throw err_2;return[4,this.deleteToken(tokenDetails.fcmToken)];case 7:throw _a.sent(),err_2;case 8:return[2]}}))}))},SwController.prototype.onNotificationClick_=function(event){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var msgPayload,link,windowClient,internalMsg;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return event.notification&&event.notification.data&&event.notification.data.FCM_MSG?event.action?[2]:(event.stopImmediatePropagation(),event.notification.close(),(msgPayload=event.notification.data.FCM_MSG).notification&&(link=msgPayload.fcmOptions&&msgPayload.fcmOptions.link||msgPayload.notification.click_action)?[4,this.getWindowClient_(link)]:[2]):[2];case 1:return(windowClient=_a.sent())?[3,3]:[4,self.clients.openWindow(link)];case 2:return windowClient=_a.sent(),[3,5];case 3:return[4,windowClient.focus()];case 4:windowClient=_a.sent(),_a.label=5;case 5:return windowClient?(delete msgPayload.notification,delete msgPayload.fcmOptions,internalMsg=createNewMsg(MessageType.NOTIFICATION_CLICKED,msgPayload),[2,this.attemptToMessageClient_(windowClient,internalMsg)]):[2]}}))}))},SwController.prototype.getNotificationData_=function(msgPayload){var _a;if(msgPayload&&\"object\"==typeof msgPayload.notification){var notificationInformation=Object(tslib_es6.__assign)({},msgPayload.notification);return notificationInformation.data=Object(tslib_es6.__assign)({},msgPayload.notification.data,((_a={}).FCM_MSG=msgPayload,_a)),notificationInformation}},SwController.prototype.setBackgroundMessageHandler=function(callback){if(!callback||\"function\"!=typeof callback)throw errorFactory.create(\"bg-handler-function-expected\");this.bgMessageHandler=callback},SwController.prototype.getWindowClient_=function(url){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var parsedURL,clientList,suitableClient,i;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return parsedURL=new URL(url,self.location.href).href,[4,getClientList()];case 1:for(clientList=_a.sent(),suitableClient=null,i=0;i<clientList.length;i++)if(new URL(clientList[i].url,self.location.href).href===parsedURL){suitableClient=clientList[i];break}return[2,suitableClient]}}))}))},SwController.prototype.attemptToMessageClient_=function(client,message){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){if(!client)throw errorFactory.create(\"no-window-client-to-msg\");return client.postMessage(message),[2]}))}))},SwController.prototype.hasVisibleClients_=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,getClientList()];case 1:return[2,_a.sent().some((function(client){return\"visible\"===client.visibilityState&&!client.url.startsWith(\"chrome-extension://\")}))]}}))}))},SwController.prototype.sendMessageToWindowClients_=function(msgPayload){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var clientList,internalMsg,_this=this;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,getClientList()];case 1:return clientList=_a.sent(),internalMsg=createNewMsg(MessageType.PUSH_MSG_RECEIVED,msgPayload),[4,Promise.all(clientList.map((function(client){return _this.attemptToMessageClient_(client,internalMsg)})))];case 2:return _a.sent(),[2]}}))}))},SwController.prototype.getSWRegistration_=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){return[2,self.registration]}))}))},SwController.prototype.getPublicVapidKey_=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var swReg,vapidKeyFromDatabase;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return[4,this.getSWRegistration_()];case 1:if(!(swReg=_a.sent()))throw errorFactory.create(\"sw-registration-expected\");return[4,this.getVapidDetailsModel().getVapidFromSWScope(swReg.scope)];case 2:return null==(vapidKeyFromDatabase=_a.sent())?[2,DEFAULT_PUBLIC_VAPID_KEY]:[2,vapidKeyFromDatabase]}}))}))},SwController}(index_esm_BaseController);function getClientList(){return self.clients.matchAll({type:\"window\",includeUncontrolled:!0})}function createNewMsg(msgType,msgData){var _a;return(_a={})[MessageParameter.TYPE_OF_MSG]=msgType,_a[MessageParameter.DATA]=msgData,_a}var index_esm_WindowController=function(_super){function WindowController(app){var _this=_super.call(this,app)||this;return _this.registrationToUse=null,_this.publicVapidKeyToUse=null,_this.manifestCheckPromise=null,_this.messageObserver=null,_this.tokenRefreshObserver=null,_this.onMessageInternal=Object(dist_index_cjs.createSubscribe)((function(observer){_this.messageObserver=observer})),_this.onTokenRefreshInternal=Object(dist_index_cjs.createSubscribe)((function(observer){_this.tokenRefreshObserver=observer})),_this.setupSWMessageListener_(),_this}return Object(tslib_es6.__extends)(WindowController,_super),WindowController.prototype.getToken=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return this.manifestCheckPromise||(this.manifestCheckPromise=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var manifestTag,manifestContent;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:if(!(manifestTag=document.querySelector('link[rel=\"manifest\"]')))return[2];_a.label=1;case 1:return _a.trys.push([1,4,,5]),[4,fetch(manifestTag.href)];case 2:return[4,_a.sent().json()];case 3:return manifestContent=_a.sent(),[3,5];case 4:return _a.sent(),[2];case 5:if(!manifestContent||!manifestContent.gcm_sender_id)return[2];if(\"103953800507\"!==manifestContent.gcm_sender_id)throw errorFactory.create(\"incorrect-gcm-sender-id\");return[2]}}))}))}()),[4,this.manifestCheckPromise];case 1:return _a.sent(),[2,_super.prototype.getToken.call(this)]}}))}))},WindowController.prototype.requestPermission=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){var permissionResult;return Object(tslib_es6.__generator)(this,(function(_a){switch(_a.label){case 0:return\"granted\"===this.getNotificationPermission_()?[2]:[4,Notification.requestPermission()];case 1:if(\"granted\"===(permissionResult=_a.sent()))return[2];throw errorFactory.create(\"denied\"===permissionResult?\"permission-blocked\":\"permission-default\")}}))}))},WindowController.prototype.useServiceWorker=function(registration){if(!(registration instanceof ServiceWorkerRegistration))throw errorFactory.create(\"sw-registration-expected\");if(null!=this.registrationToUse)throw errorFactory.create(\"use-sw-before-get-token\");this.registrationToUse=registration},WindowController.prototype.usePublicVapidKey=function(publicKey){if(\"string\"!=typeof publicKey)throw errorFactory.create(\"invalid-public-vapid-key\");if(null!=this.publicVapidKeyToUse)throw errorFactory.create(\"use-public-key-before-get-token\");var parsedKey=base64ToArrayBuffer(publicKey);if(65!==parsedKey.length)throw errorFactory.create(\"public-vapid-key-decryption-failed\");this.publicVapidKeyToUse=parsedKey},WindowController.prototype.onMessage=function(nextOrObserver,error,completed){return\"function\"==typeof nextOrObserver?this.onMessageInternal(nextOrObserver,error,completed):this.onMessageInternal(nextOrObserver)},WindowController.prototype.onTokenRefresh=function(nextOrObserver,error,completed){return\"function\"==typeof nextOrObserver?this.onTokenRefreshInternal(nextOrObserver,error,completed):this.onTokenRefreshInternal(nextOrObserver)},WindowController.prototype.waitForRegistrationToActivate_=function(registration){var serviceWorker=registration.installing||registration.waiting||registration.active;return new Promise((function(resolve,reject){if(serviceWorker)if(\"activated\"!==serviceWorker.state)if(\"redundant\"!==serviceWorker.state){var stateChangeListener=function(){if(\"activated\"===serviceWorker.state)resolve(registration);else{if(\"redundant\"!==serviceWorker.state)return;reject(errorFactory.create(\"sw-reg-redundant\"))}serviceWorker.removeEventListener(\"statechange\",stateChangeListener)};serviceWorker.addEventListener(\"statechange\",stateChangeListener)}else reject(errorFactory.create(\"sw-reg-redundant\"));else resolve(registration);else reject(errorFactory.create(\"no-sw-in-reg\"))}))},WindowController.prototype.getSWRegistration_=function(){var _this=this;return this.registrationToUse?this.waitForRegistrationToActivate_(this.registrationToUse):(this.registrationToUse=null,navigator.serviceWorker.register(\"/firebase-messaging-sw.js\",{scope:\"/firebase-cloud-messaging-push-scope\"}).catch((function(err){throw errorFactory.create(\"failed-serviceworker-registration\",{browserErrorMessage:err.message})})).then((function(registration){return _this.waitForRegistrationToActivate_(registration).then((function(){return _this.registrationToUse=registration,registration.update(),registration}))})))},WindowController.prototype.getPublicVapidKey_=function(){return Object(tslib_es6.__awaiter)(this,void 0,void 0,(function(){return Object(tslib_es6.__generator)(this,(function(_a){return this.publicVapidKeyToUse?[2,this.publicVapidKeyToUse]:[2,DEFAULT_PUBLIC_VAPID_KEY]}))}))},WindowController.prototype.setupSWMessageListener_=function(){var _this=this;navigator.serviceWorker.addEventListener(\"message\",(function(event){if(event.data&&event.data[MessageParameter.TYPE_OF_MSG]){var workerPageMessage=event.data;switch(workerPageMessage[MessageParameter.TYPE_OF_MSG]){case MessageType.PUSH_MSG_RECEIVED:case MessageType.NOTIFICATION_CLICKED:_this.messageObserver&&_this.messageObserver.next(workerPageMessage[MessageParameter.DATA])}}}),!1)},WindowController}(index_esm_BaseController);function isSupported(){return self&&\"ServiceWorkerGlobalScope\"in self?\"PushManager\"in self&&\"Notification\"in self&&ServiceWorkerRegistration.prototype.hasOwnProperty(\"showNotification\")&&PushSubscription.prototype.hasOwnProperty(\"getKey\"):navigator.cookieEnabled&&\"serviceWorker\"in navigator&&\"PushManager\"in window&&\"Notification\"in window&&\"fetch\"in window&&ServiceWorkerRegistration.prototype.hasOwnProperty(\"showNotification\")&&PushSubscription.prototype.hasOwnProperty(\"getKey\")}index_cjs_default.a.INTERNAL.registerService(\"messaging\",(function(app){if(!isSupported())throw errorFactory.create(\"unsupported-browser\");return self&&\"ServiceWorkerGlobalScope\"in self?new index_esm_SwController(app):new index_esm_WindowController(app)}),{isSupported:isSupported})}}]);","extractedComments":[]}